# 갑작스러운 오류 발생 원인 분석

## 🔍 발견된 주요 원인

### 1. **CCTV 스트림 URL 만료/접근 거부 (HTTP 403 Forbidden)**
- **증상**: `Server returned 403 Forbidden (access denied)`
- **원인**: 
  - CCTV 서버의 스트림 URL이 일시적으로 만료됨
  - 접근 권한이 제한됨
  - 서버 측 접근 제한 정책
- **영향**: FFmpeg가 스트림을 시작할 수 없어 500 에러 발생

### 2. **FFmpeg 프로세스 예기치 않은 종료**
- **증상**: `FFmpeg process exited with code 1`
- **원인**:
  - 네트워크 연결 끊김
  - CCTV 서버 측 연결 종료
  - 리소스 부족
- **영향**: 실행 중이던 스트림이 갑자기 중단됨

### 3. **프로세스 상태 관리 문제**
- **증상**: `active_streams`에 종료된 프로세스가 남아있을 수 있음
- **원인**:
  - `_monitor_stream`이 비동기로 실행되어 즉시 감지하지 못함
  - 프로세스가 종료되어도 `active_streams`에서 제거되지 않을 수 있음
- **영향**: 메모리 누수 및 잘못된 상태 관리

### 4. **에러 메시지가 빈 문자열로 반환**
- **증상**: `Error starting stream:` (메시지 없음)
- **원인**: 
  - FFmpeg stderr를 읽는 타이밍 문제
  - 프로세스가 너무 빨리 종료되어 에러 메시지를 읽지 못함
- **영향**: 디버깅 어려움

---

## 🛠️ 개선 방안

### 1. **스트림 URL 유효성 사전 검증**
- 스트림 시작 전 URL 접근 가능 여부 확인
- HTTP HEAD 요청으로 사전 검증

### 2. **프로세스 상태 주기적 확인**
- 주기적으로 `active_streams`의 프로세스 상태 확인
- 종료된 프로세스 자동 정리

### 3. **재시도 메커니즘**
- 일시적 실패 시 자동 재시도
- 지수 백오프(exponential backoff) 적용

### 4. **에러 메시지 개선**
- FFmpeg stderr를 실시간으로 읽어 에러 메시지 보존
- 더 명확한 에러 메시지 제공

### 5. **스트림 상태 모니터링**
- 주기적으로 스트림 상태 확인
- 실패한 스트림 자동 복구 시도

---

## 📊 발생 빈도가 높은 오류

1. **HTTP 403 Forbidden** (가장 빈번)
   - CCTV 서버의 접근 제한
   - URL 만료
   
2. **프로세스 예기치 않은 종료**
   - 네트워크 문제
   - 서버 측 연결 종료

3. **404 Not Found** (상대적으로 드묾)
   - 잘못된 URL
   - CCTV가 비활성화됨

---

## 💡 권장 조치사항

### 즉시 조치
1. ✅ 에러 메시지 개선 (완료)
2. ✅ HTTP 상태 코드별 처리 (완료)
3. ⏳ 프로세스 상태 주기적 확인 (추가 필요)
4. ⏳ 스트림 재시도 로직 (추가 필요)

### 장기 개선
1. 스트림 URL 캐싱 및 갱신
2. 헬스체크 엔드포인트 추가
3. 모니터링 대시보드 구축
4. 자동 복구 메커니즘

---

**분석 일시**: 2026-01-05  
**로그 기반**: `/tmp/cctv-backend.log`

